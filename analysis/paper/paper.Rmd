---
title: "Changes in Mobility and Site Occupation during the Late Pleistocene in Korea"
author:
  - Author Gayoung Park
  - Author Ben Marwick
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    bookdown::html_document2:
      fig_caption: yes
      reference_docx: "../templates/template.docx" # Insert path for the DOCX file
bibliography: references.bib
csl: "../templates/journal-of-archaeological-science.csl" # Insert path for the bib-style
abstract: |
  The Late Pleistocene saw the introduction of new lithic technologies to the Korean Peninsula, especially stemmed points and blades. We examined stone artifacts from 22 sites in Korea to investigate how the introduction of  new tools changed the way people used the landscape, and the way people used sites. We analyzed artifact density, retouch frequency, radiocarbon ages, site elevation, raw material types, and composition of the toolkit to test hypotheses about site use. The results show that the new technology enabled the occupation of marginal environments at higher elevations. We find no strong relationship between technology and ecological change. Instead, we assume that population dynamics might have had more impact on changes in stone artifact technology and hunter-gatherer foraging strategies. 
keywords: |
  keyword 1; keyword 2; keyword 3
highlights: |
  These are the highlights. 
editor_options: 
  chunk_output_type: console
---


<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

```{r, setup, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  fig.path = "../figures/"
)

#library(koreapaleolithicmobilityoccupation)# Or use devtools::load_all('.', quiet = T) if your code is in script files, rather than as functions in the `/R` diretory
```

```{r setup, include=FALSE}
suppressPackageStartupMessages(library(tidyverse))
library(glue)
library(ggrepel)
library(here)

korean_archaeological_sites <- readxl::read_excel(here("analysis/data/raw_data/korean-archaeologica-sites.xlsx"))

# data from PhD data sheet, not KAS sheet.
mydata <- read.csv(here("analysis/data/raw_data/General_info.csv"))

# raw material data from KAS data sheet.
kasr <- read.csv(here("analysis/data/raw_data/Rawmaterial_info.csv"))

# assemblage composition data from KAS data sheet.
kasa <- read.csv(here("analysis/data/raw_data/Assemblage_info.csv"))

#volume of the cultural layer from KAS data sheet.
kasv <- read.csv(here("analysis/data/raw_data/Dating_info.csv"))

dates <- read.csv(here("analysis/data/raw_data/Radiocarbon dates.csv"))

```

```{r}

# join artefact type freqs with site data

kasa %>% 
  pivot_longer(-X, 
               names_to = "site_name",
               values_to = "count") %>% 
  pivot_wider(names_from = "X",
              values_from = "count") %>% 
  left_join(mydata)

```

# Introduction

The appearance of stemmed points in the Late Pleistocene (~40-35 ka) in Korea is often assumed to have transformed forager lifeways because it is thought to reflect more specialed hunting practices [@lee2002new;@seong2008tanged;@chang2013human]. Stemmed points are likely to have been projectile weapon tips because the stem of these tools is cconsidered to represent halfting technology that joins the lithic to a wooden shaft. Stemmed points represent the first appearance of halfting technology in Korea. Here we explore questions about these transformations using as behavioural ecology framework to explore changes in the way people used the landscape, and the way people used sites. We examined stone artifacts from 22 sites in South Korea to investigate the technological transition represented by the appearance of a new tool, stemmed points, and the blade industry that followed. Previous work on this technological change in Korea has focussed on issues of the transition from the Early to the Late Paleolithic and modern human dispersals [@norton2009evolution; @bae2010origin]. To our knowledge, the implications for forager mobility and site use have not been explored in detail. Most Korean Paleolithic sites do not preserve organic remains, so we lack direct faunal evidence on hunting and subsistence strategies. Here, we attempt to identify patterns of mobility through analysis of the stone artefact assemblages using Human Behavioral Ecology (HBE) models. Drawing on established relationships between lithic technology and forager mobility [@shott1986settlement; @Hiscock_1994; @kuhn1994formal; @kuhn2004upper; @kuhn2015artifacts; @kuhn2016moves; @capriles2018], we hypothesize that the appearance of the new hunting tool might reflect a preference for more portable and efficient technologies, that are part of a broader strategy of moving frequently and further, possibly as an adaptation to population or environmental changes. 

<!-- generally, how do we make sense of new stone tools... When a new stone artefact technology appears, how do we explain that? new species... population movements... (great basin)... environment... (Mesolithic & bow and arrow)...  risk management (Australian small tool tradition) --> 
<!-- Do you want to have one more paragraph for the general tradition of explaining the emergence of new stone tools? -->


# Background

### Regional archaeology

In the Eastern hemisphere, striking technological innovations during the Late Pleistocene are restricted to Northeast Asia, such as northern China, Japan and Korea. These innovations include blade and micro technology, high frequencies of retouched blade tools, several novel refined tools such as projectile points, stemmed points, end scrapers, burins, denticulates, etc, and using high-quality raw materials [@bar1999big; @brantingham2001initial; @Bar-Yosef_2002; @bae2017origin; @nakazawa2018quaternary]. Previous work has argued that the appearance of new stone artefact technologies in this region may be linked to modern human dispersals by focusing on the origin of the new tools [@seong2008tanged;@bae2010origin;@Bae_2010; @bae2017origin].

The Shuidonggou site in northern China is a typical site for showing the transition from cobble to blade tool industries in the Late Pleistocene of Northeast Asia from the Late Pleistocene to Middle Holocene [@Brantingham_Perreault_2010; @Gao_Zhang_Yang_Shen_Wu_2010; @pei2012shuidonggou]. Shuidonggou Localities SDG 2, which dated around c.32,000 years, contains aunal specimens,ostrich eggshell beads,and stone artefacts including blades, retouched flakes, cores, and debries along with well-preserved hearths. In Locality 9 dated to c.29,000years, there is a small scatter of stone artefacts consists of blades, Levallois flakes, cores and other retouched flakes. The recent excavtion of Locality 12 shows that its archaeological layer <!--I shouldn't use 'layer', but I don't know what to say shortly-->, dated to 13,078–13,296 cal BP, includes ground stone and more than 30,000 microlithics made out of a variety of raw materials such as fine-grained and siliceous rocks. In addition, more than 10,000 animal fossils and bone tools including a tool for fishing nets, an awl, and two needles were excavated [@pei2012shuidonggou; @gao2014discovery; @zhang2016bone].<!-- they use OSL data that has wise range, or calibrated years --> Based on the archaeological records, people argue that a microblade technology appeared in China after 29ka BP related to mobility change along with colder climate towards LGM and changed game as surviving strategy [@yi2014significance]. The accumulated studies on Shuidonggou site show that the blade compoenent is claimed to have come from Siberia and/or Mongolia at 41 ka (SDG Locality1 and 9), advanced core and flake tools are likely to be locally developed at 33ka (2 and 8), and at 10.8 ka microblade technology appears but the origin is uncertain (12) [@yi2014significance; @li2019history].

<!-- the last sentense is a bit long-->
<!-- "advanced core and flake tools means intentionally prepared platforms and working surfaces, selective raw material usage (using chert rather tahn river pebble), bipolar reduction, and generating small elongated blanks as results" -->

The origins of Late Pleistocene technological innovations in Japan is suddenly appeared in differen regions of the archipelago around 38,000 years ago accaompanying with Homo sapiens found in Okinawa Island (ca. 36,000 cal BP) [@yamaoka2012use; @izuho201421]. The components of the new technologies represented by trap pits, cobble concentrations, hearths, charcoal concentrations, and toolkits including trapezoids, pointed-shaped backed blades, backed points, burins, end scrapers, side scrapers, wedges, beak- shaped tools, axes, edge-ground axes, hammerstones, cobble tools, and anvils [ @bae2017origin; @izuho201421]. These innovations have been interpreted as evidnce of new foraging methods such as watercraft (marine transport of obsidian from the Kozu Island) and bow-and-arrow technology, drivien by increased population and ecological changes [@Yamaoka_2012; @bae2017origin; @Nakazawa_Bae_2018; @morisaki2019early]. Especially, hafted trapzoids were designed to be used as multifucntional tools and people tried to maintain and resue trapezoids and tools euipped with trapzoid to adapt to the specific environmental settings on the Japanese Islands [@ono2002radiocaron; @yamaoka2012use]. Ishinomoto 8-ku is one of the earliets sites dated to 39,690–34,790 cal BP, located in Takuma upland of Kumamoto Prefecture. A total of 500 stone artifacts were discovered including trapezoids, side scrapers, flakes, flake cores, edge-ground axes, and cobble tools. The main lithic raw materials are chert and andesite [@izuho201421].      


<!--do we need to talk about AT???People had assumed that Japanese archipelago started to be occupied before 30,000 cal BP based on the existence of primary Aira-Tanzawa tephra (dated at 30,009±189 cal BP) in the excavation unit. Recenly, accummulated radiocarbon data show that --> 
<<!-- do we need to mention popular research topic such as existance of pre UP ("archaic industries")as a heated debate?--->

The Late Pleistocene technological transition in Korea is mainly characterized by the early appearance of stemmed points, followed by blade technology. The stemmed point is a projectile point made out of elongated flake or blade and with slight retouch on the proximal end to shape an acute tip and on the distal end to make a stem, which connects to a shaft. The earliest stemmped points were made on flakes. After blades appear at c. 27 ka, the shape of stemmped points became more standardized with one or two ridges on dorsal side and triangular cross section. The stemmed point is often called as a tanged point in western hemisphere, but we use 'stemmed point' to distinguish from Bronze Age stone projectile points in Korea that have long been called 'tanged points'. Stemmed points were made from blade blanks, and became more standardized and increased in quantity over time. Flake tools became more complex, with a greater diversity in both type and size along with continuously used core tools during the Late Pleistocene  [@Bae_2010; @Lee_2013; @Lee_2016]. The oldest stemmed points so far is from the Yongho-dong site dated to 38.5 ka [@seong2009emergence; #### Park 2012 ####; @seong2015diversity; @bae2017origin]. 

The origin of the stemmed point is one of the most frequently discussed topics among Paleolithic research in Korea. Especially, this debate includes questions about the origin of the Late Paleolithic period in Korea, the existence and nature of Middle Paleolithic technology, and reconstructions of anatomically modern human dispersals in eastern Asia. Most Korean archaeologists had assumed that the new blade technology represented came from Shuidonggou in the northeast China because this site has one of the earliest blade industries (around 35,000 BP) in northeast Asia and it is geographically close to the Korean peninsula [seong2008tanged; @lee2013current]. However, signs of early technological change in Korea, including stemmed points and blades, have been discovered from deposits dated to 40-35 ka BP from Hwadae-ri, Hopyeong-dong, and Yongho-dong, pre-dating the Shuidonggou finds [@seong2009emergence]. The debate about origins can be summarized into two models competing to explain the appearance of the new Late Pleistocene technologies: in situ evolution [@seong2009emergence] and ‘heterogenic’ migration [@bae2010origin]. The ‘in situ’ model claims that stemmed points and other Late Paleolithic assemblages including a blade industry autonomously emerged in the south of the Korean peninsula with no external influence. Seong (2009) uses the blade-to-flake ratios of lithic assemblages to support his claim. In his view, the blade industry represents new technology while flakes indicate a continuing local one. He argues that the increased ratio of blades in lithic assemblages shows an expansion of the new technology. The migration model argues that the new blade industry, including stemmed points, and the earlier coarse flake tradition including large cores, polyhedrons, choppers, and even handaxes, came from different origins. While Seong’s model (2009) proposes that the ‘heterogenic’ character is the result of indigenous development, Bae (2010) proposes that it is the result of the continuous influx of modern human populations from both Siberia and southern China. Bae’s model suggests blade technology arrived in the Korean peninsula from Siberia, Mongolia, or other regions of northeast China following the Liaohe and Sunghe rivers around 35 ka BP [@bae2013early]. 
<!--- I don't know how to connect this debate to our research. It is really needed? --->


### Behavioural ecology and forager land use behaviours

Our review of Late Pleistocene technological innovations in Northeast Asia shows that previous work has largely focussed on timing, location, origins and description of these new tools, but there has been little effort to model the land-use behaviours that generated these assemblages. We focus on the appearance of stemmed points in Korea because these are one of the earliest new technologies that definiately represents a new hunting methods because the halfting implies throwing techniques that can reach long-distance targets [@Keeley_1982; @kuhn2015artifacts]. We ask two questions to invetigate the period around the introduction of stemmed points in Korea. 

First, we ask how the introduction of the new tools changed foragers' landscape use, specifically, was the use of stemmed points associated with occupation of marginal or exterme environments? The new technology might allow foragers to explore and stay in different or harsher territories by increasing mobility. For instance, Morisaki et al. argue that the transition from trapezoid to the blades and projectile points around 25 ka cal BP in north Paleo-Honshu Island enabled the foragers to extend their occupation at residential sites [@Morisaki_Izuho_Terry_Sato_2015]. In Australia during the mid-Holocene, the highly retouched and finely shaped tools combined with shafts were appeared to  broaden their occupations to offshore islands on the northeast and northwest coast [@Hiscock_1994]. Hiscock et al. insist that the appearance of mirolithcs is great example to show that people made portable and multi-functional tools to minimize the travel expense and increase tool readiness [@Hiscock_Clarkson_Mackay_2011].

Second, we focus on how the new technology changed the way people use their habitation sites. After the appearance of these new tools, did they tend to stay in one location longer, or for shorter periods, perhaps for specific purposes?. Archaeological sites indicate depositional phenomena and places where artifacts and other debris accumulated reflecting human activities in the past [@kuhn2015artifact]. The stone artifact assemblage from a site can inform us how long individuals or groups stayed and give insignts into what they did there [@binford1979organization; @kelly1995foraging; @kuhn2016moves; @holdaway2019surface]. Stone artifacts can contain a record of raw material transport and selection and give insights into land-use behaviour [@clarkson2008lithics]. For example, stone artifact density and the frequency of retouched pieces (scaled to the volume of excavated sediment) are often used as proxies to represent occupation patterns. Assemablges with low density but a high proportion of retouched and backed pieces would indicate the remains of 'short-term camp', while the combination of high density and low retouched pieces represent 'logistically organized basecampe' [@clark2017lithics; clark2019landscapes].




<!-- Lastly, we want to know about population dynamics during the transition period based on a premise that population change could be a driver of the new invention as well as the source of it if they brought the new tools from outside. The demands derived from significan population dynamic in addition to environmental change could lead to development of the tools [buchanan2016drivers; @mihailovic2016technological; prufer2019linking]. Some studies argue that technological complexity and richness are highly influenced by population size because in large population, because new innovation could occur during the process of learning from others [@shennan2001demography; @henrich2004demography; @collared2005causes; @collard2013risk; @buchanan2016drivers]. Therefore, we will check the population change during the transitional period to understand its impact on the technology. -->





# Methods

Sites and dates

The data analyzed in this paper are gathered from published excavation reports of 22 Paleolithic open air sites in South Korea dating from 49k BP to 24k BP. Within these 22 sites we have 33 assemblages.  Multiple assemblages in a site were distinguised culturally sterile deposits in between artefact-bearing deposits, or by stratigraphic units identified by major differences in the texture and composition of the sedimentary deposit containing the stone artefacts. After the first excavation at Jeongokri site in the late 1970s, more than 200 Paleolithic sites are discovered in Korea. Among them, we  chose 22 sites based on absolute dates that span our period of interest. We include sites dated before and after the transition period (40-35 ka) to analyze the process of technological transition. 

```{r cache = TRUE, fig.cap="Map of sites discussed in the text."}

```

Assemblages


The research analyzes total 33 assemblages [need to explain what is the difference between 'assemblage' and 'site'] and they consist of cores, blade cores, blades, flakes, debris, hammers, choppers, plans, polyhedrals, side scrapers, end scrapers, notches, cleavers, stemmed points, awls, denticulates, burins, handaxes, blanks, knives, handadzes, peaks, flatters, flakers etc.




Some artifacts are not included as certain tools due to their vague or broken shape presumably related to the characteristics of raw materials such as quartz, quartz vein, and quartzite. In that case, we named them as unknown, unfinished, or pebble. The stone artifacts from all of these sites are stored in museums located throughout South Korea, and have been briefly described in the excavation reports. We have visited most of these collections, collected PDFs of the excavation reports, and negotiated permission to study the materials. For example, the Hwadae-ri site has three cultural layers. The lowest horizon at the bottom, dated to 39,000±1400 BP by OSL, contains coarse flake tools made of vein quartz and quartzite. The middle cultural horizon has stemmed points made of porphyry, with quartz and quartzite dominating the assemblage. This layer dated to 31,200±900 BP by radiocarbon dating and 30,000±1,700 BP by OSL. The uppermost layer, dated to 22,000±100 BC by OSL, contains blades, scrapers, awls, and denticulates [@seong2009emergence]. We compare the assemblages from the two older layers at this and other sites to investigate the transition process.     

Statistical methods 

To answer the three research questions, we gather information such as elevation of the sites, artifact density, retouch frequency, radiocarbon dates toolkit composition, and raw material type. The elevation is the main proxy for environmental information in this research. The Korean paleoenvironmental data and information are not rich enough to directly apply HBE driven models or questions [####Han 2008####; @Chang_2013]. Rather, the paleoenvironment of the Korean Peninsula for this proposed research time period can be simply summarized as ‘overall cooler and drier during MIS 3’ [###Han 2008###; ####Seong 2008####; ###Choi 2011####; @Chang_2013; @im2015study; @bak2017late]. In this regard, it is much harder to understand the regional as well as shorter-time scale of paleoenvironmental change in the Korean Peninsula. In addition, the targeting period is not exactly matched with major environmental changes that we can check through global sea level change, it seems rather monotonous around 40-35 ka [@Bailey_2010; @Lorscheid_Stocchi_Casella_Gómez-Pujol_Vacchi_Mann_Rovere_2017]. In this research, we chose elevation to make a premise that the site elevation can represent different environment in local scale and hunter-gatherers moved to different elevation as a result of environment related risk. This research focuses on the change of the elevation of the sites throughout time and accompanying toolkits, and its relationship with the appearance of new tools.

The artifact volumetric density is defined as the total number of artifacts per cubic meter of excavated sediment, and served as a proxy for accumulation ratio of artifacts [@clark2017lithics; @clark2019landscapes]. We expected to use this value to evaluate mobility and land-use practices of hunter-gatherers during the Late Pleistocene. We count the retouch frequency as the number of retouched tools divided by the total number of artifacts. This value represents general proficiency of lithic manufacturing, raw material availability, and foraging strategies including mobility and duration of site occupation based on the concept that tool reductioning is an economical tactic to generate sharp, usable edges while minimizing the cost of transporting tools or bulky raw materials by reducing the total load weight [@Kuhn_1990; @clark2019landscapes]. In other words, producing and carrying highly retouched tools will increase portability and efficiency by decrease in the size of both individual tools and the assemblages so that hunter-gatherers could move often or further, or both [@kuhn1991unpacking; @kuhn1994formal; @kuhn2004upper; @andrefsky1994raw; @davies2018modeling]. For example, highly retouched and finely shaped implements appeared in Australia during the mid-Holocene to minimize risk associated with environmental change and high mobility [@Hiscock_1994].

Combined the two proxies, the artifact volumetric density and the retouch frequency, we expect to determine whether or not the hunter-gatherers were residentially mobile or logistically organized. If the assemblage in a site has high density and less retouched, it is depicted as expedient assemblage that represents “base camps” or “residences”, while less density with high retouched one shows curated assemblage and indicates either residential mobility or certain task groups from main residential site [@Riel-Salvatore_Barton_2004; @clark2017lithics].

Radiocarbon dates provide a proxy for change in human population levels. Summed probability distributions (SPD) of radiocarbon dates are often used to understand temporal trends in ancient human populations [@rick1987dates; @bamforth2012radiocarbon; @shennan2013regional; @timpson2014reconstructing; @contreras2014summed]. Even though there must be unavoidable limitations for the validity of SPD such as the lack of excavated sites in certain period, this method is still helpful to be used as a proxy for population fluctuation. Timpson et al. demonstrate its usefulness by testing data sets in 12 European regions and assert that this SPD is extremely robust to deal with small sample size [@timpson2014reconstructing]. We use 171 radiocarbon dates from 22 sites to search for population trends during the Late Pleistocene in Korea based on the premise that population change or pressure could be another catalyst to improve or innovate technology.      

In terms of the composition of toolkits, we count kind of tools as well as the amount of debitabitage to search for the change in the toolkits around the transition period. The tools represent paleo hunter-gatherers’ adaptive strategies. We analyze the composition of raw materials in the assemblages to see the relationships between the choice of specific raw materials and technological innovation as well as raw material availability and its consuming pattern based on an assumption that stone raw materials were carefully transported and consumed to optimize mobility and technological strategies, depth of planning in landscape use and risk minimization [@brantingham2003neutral].

Umap: <- depending on whether we are gonna add umap (or PCA) analysis result 



# Results

Elevation of occupied sites

The result of the elevation change of 33 cultural layers from 22 sites corresponding to the targeting period shows that there is no remarkable change can be seen in site elevation during the transition (Fig.1: with no sp site distinction). We applied the existence of the stemmed points to the elevation to understand the benefit of having the points in the toolkit and the result indicates that the hunter-gathering groups who carried the technology could occupy higher altitude while the groups with no points stayed at the lower altitude (Fig. 2: distinction between sites with no stemmed points and with stemmed points). 

```{r}
# site elevation
kasv_tidy <- 
kasv %>% 
  t %>% 
  as_tibble() %>% 
  setNames(as.character(.[1,])) %>% 
  .[-1,] %>% 
  mutate_all(parse_number) %>% 
  mutate(artefact_density = total_artifacts / volume,
         sites = names(kasv)[-1]) %>% 
  left_join(mydata, by = c('sites' = 'site_name' )) %>% 
  mutate(has_sp = ifelse(is.na(SP.), "no", "yes"))


mydata_ages <- 
  mydata %>% 
  separate(C14.BP., into = c('age', 'error'),
          sep = "±") %>% 
  mutate(age_ka = parse_number(age) / 1000,
         error = parse_number(error)) %>% 
  mutate(has_sp = ifelse(!is.na(SP.), "yes", "no"))

# compute t-test 
elev_sp_ttest <- 
  t.test(altitude.m._of_main_layer ~ has_sp, data = kasv_tidy)

# extract elements from the t-test output
elev_sp_ttest_t <- round(unname(elev_sp_ttest$statistic), 3)
elev_sp_ttest_p <- round(unname(elev_sp_ttest$p.value ), 3)
elev_sp_ttest_df <- round(unname(elev_sp_ttest$parameter ), 3)

# t(degress of freedom) = the t statistic, p = p value.
elev_sp_ttest_str <- 
  paste0("t(", elev_sp_ttest_df, ") = ", elev_sp_ttest_t, ", p = ", elev_sp_ttest_p)


elevation_sp_sub_plot <- 
ggplot(kasv_tidy,
       aes(has_sp, 
           altitude.m._of_main_layer)) +
  geom_boxplot() +
  annotate("text", 
           x = 1.5, 
           y = 250,
           label = elev_sp_ttest_str) +
  theme_bw(base_size = 8)  +
  labs(x = "Stemmed points present",
       y = "Elevation above sea level (m)")

elevation_sp_main_plot <- 
ggplot(mydata_ages, 
       aes(x = age_ka,
           y = altitude.m._of_main_layer,
       color = as.factor(has_sp))) +
  geom_point(size = 3) +
  xlab("Age of occupation (ka)") +
  ylab("Elevation above sea level (m)") +
  geom_smooth(se = FALSE) +
  scale_colour_discrete(name = "Contains\nstemmed\npoints?") +
  theme_minimal(base_size = 16)  +
  theme(legend.position = c(0.1, 0.9)) 


library(cowplot)
ggdraw(elevation_sp_main_plot) +
  draw_plot(elevation_sp_sub_plot, 
            .7, .60, 
            .25, .32) 
```

Artifact density and Composition of toolkit

During the transitional period, the artifact volumetric density was relatively small but it becomes higher around 30 ka (Fig. 3: the transition of artifact volumetric density). When it comes to the composition of the toolkit, it is hardly recognized any pattern of changes over time (Fig. 4: the composition of toolkit). Both results with no information about raw material availability near the 22 sites, we assume that the artifact density might relate to the duration of site occupation or group size rather than portability and efficiency of tools. In other words, the small artifact density might indicate shorter duration or smaller group size. Likewise, the composition of toolkit might represent the characteristics or purpose of each site, rather than showing general pattern of chronological change.    


```{r}
#Volume and artefact counts to get density over time. 

density_sp_sub_plot <- 
ggplot(kasv_tidy,
       aes(has_sp, 
           artefact_density)) +
  geom_boxplot() +
  theme_bw(base_size = 8)  +
  labs(x = "Stemmed points present",
       y = "Artefact density")

density_sp_main_plot <- 
ggplot(kasv_tidy,
       aes(date_age / 1000,
           artefact_density)) +
  geom_point(aes(size = total_artifacts,
                 colour = has_sp)) +
  ylab(bquote('Artefact density'~(n/m^3))) +
  xlab("Age of assemblage (ka)") + 
  #geom_smooth(method = "lm") + 
  scale_size_continuous(name = "Total number\nof artifacts")  +
  scale_color_viridis_d(name = "Contains\nstemmed\npoints?") +
  theme_minimal(base_size = 16)  #+
  #geom_text_repel(aes(label = sites),
  #                nudge_x = 0.25, 
  #                nudge_y = 0.25) 

# https://wilkelab.org/cowplot/articles/drawing_with_on_plots.html
library(cowplot)
ggdraw(density_sp_main_plot) +
  draw_plot(density_sp_sub_plot, 
            .375, .67, 
            .25, .25) 

ggsave("figures/age-by-density.png")
```

```{r}
#the artifact composition of each sites to figure out what people did as they were occupying the sites.
kasa_long <-
  kasa %>%
  gather(site, 
         count, 
         -X) %>% 
  filter(!is.na(count)) %>% 
  group_by(site) %>% 
  mutate(percentage = count / sum(count, na.rm = TRUE) * 100,
         total = sum(count, na.rm = TRUE)) %>% 
  filter(!is.na(percentage)) %>% 
  # if percentage is <10%, call it 'other'
  mutate(artefact_type = ifelse(as.character(X) == 'stemmed_point',
                                'stemmed_point', 
                                ifelse(percentage >= 10, 
                                as.character(X), "other_tools"))) %>% 
  mutate(axis_label = as.character(glue('{site}\n(n = {total})')))  %>% 
  # join to get ages of the sites
  left_join(mydata_ages, 
            by = c('site' = 'site_name')) %>% 
  arrange(age_ka) #%>% 
  # mutate(age_ka = jitter(age_ka))

ggplot(kasa_long, 
       aes(age_ka, 
           percentage,
           fill = artefact_type)) +
  geom_col(position = "fill") +
  ylab("Percentage") +
  xlab("Age of assemblage (ka)") +
    scale_fill_viridis_d(name = "Artifact type",
                       option = "D") +
  coord_flip() +
  theme_minimal(base_size = 16) 

# comparable figure to the raw material one (BM created)
  
kasa_long1 <-
  kasa %>%
  gather(site, 
         count, 
         -X) %>% 
  filter(!is.na(count)) %>% 
  group_by(site) %>% 
   mutate(percentage = count / sum(count, na.rm = TRUE) * 100,
         total = sum(count, na.rm = TRUE)) %>% 
  filter(!is.na(percentage)) %>% 
  # if percentage is <10%, call it 'other'
  mutate(artefact_type = ifelse(as.character(X) == 'stemmed_point',
                                'stemmed_point', 
                                ifelse(percentage >= 10 | X == "unkown", 
                                as.character(X), "other_tools"))) %>% 
  mutate(axis_label = glue('{site}\n(n = {total})'))  %>% 
  select(-X)
  # join to get ages of the sites
kasa_long2 <- 
kasa_long1 %>% 
  group_by(site, 
           artefact_type) %>% 
  summarise(percentage = sum(percentage)) %>% 
  left_join(mydata_ages, 
            by = c('site' = 'site_name')) %>% 
  arrange(age_ka) %>% 
  distinct(.keep_all = TRUE) %>%
  filter(!is.na(age_ka)) %>% 
  mutate(axis_label = glue('{site} ({round(age_ka,1)} ka)')) 

ggplot(kasa_long2, 
       aes(
           reorder(axis_label, -age_ka),
           percentage,
           fill = artefact_type)) +
  geom_col(position = "fill") +
  ylab("Percentage") +
   xlab("Assemblage (youngest at the top)") +
  theme_minimal(base_size = 16)  +
    scale_fill_viridis_d(name = "Artefact type",
                       option = "D") +
  coord_flip() +
  theme_minimal(base_size = 12) 
ggsave("figures/artefact-types.png")

```
Artifact density and retouch <- maybe we need to add the result of retouch, separately 
We use the combination of the artifact density and retouch frequency as a proxy to identify the mobility and residential pattern of hunter-gatherers. The result shows that there is no clear pattern during the transition period and then it became more expedient at the end of the transition (Fig 5. The combination of artifact density and retouch). That is to say, the hunter-gatherer became either more residential or the majority of the site that this research studies were used as base camps or residence rather than shortly occupied camps for certain tasks. 


```{r}
# retouch, density, age
Assemblage_info <- read_csv(here::here("analysis/data/raw_data/Assemblage_info.csv"))

Assemblage_info_retouch_density_ages <- 
Assemblage_info %>% 
  pivot_longer(-X1, 
               names_to = "sites") %>% 
  left_join(kasv_tidy)

Assemblage_info_retouch_density_ages_prop <- 
Assemblage_info_retouch_density_ages %>% 
     filter(!X1 %in% c("debris", 
                     "unkown", 
                     "pebble",  
                     "metate", 
                     "flake",
                     "unfinished",
                     "ground",
                     "blank"
                     )) %>% 
  group_by(sites) %>% 
  mutate(prop_retouched = sum(value, na.rm = TRUE) / total_artifacts) %>% 
  arrange(sites) %>% 
  select(-X1, -value) %>% 
  distinct_all()

# retouch over time
retouch_over_time_subplot <- 
ggplot(Assemblage_info_retouch_density_ages_prop,
       aes(date_age / 1000,
           prop_retouched)) +
  geom_point(size = 3, 
             colour = "grey80") +
  labs(x = "Age of assemblage (ka)",
       y = "Proportion retouched") +
  theme_bw(base_size = 6)

# compute correlation
kas_sites_retouch_density_corr <- 
cor.test(Assemblage_info_retouch_density_ages_prop$prop_retouched,
         Assemblage_info_retouch_density_ages_prop$artefact_density)

r_value <- unname(kas_sites_retouch_density_corr$estimate)
p_value <- unname(kas_sites_retouch_density_corr$p.value )
t_value <- unname(kas_sites_retouch_density_corr$statistic )
df_value <- unname(kas_sites_retouch_density_corr$parameter )

size <-  8
Assemblage_info_retouch_density_ages_prop_main_plot <- 
ggplot(Assemblage_info_retouch_density_ages_prop,
       aes(artefact_density,
           prop_retouched
           )) +
  geom_point(aes(colour = date_age / 1000,
                 size = total_artifacts,
                 shape = has_sp)) +
 # geom_text_repel(aes(label = sites),
 #                 nudge_x = 0.075, 
 #                 nudge_y = -0.075,
 #                 size = 5) +
  geom_smooth(alpha = 0.2,
              method = "lm") +
  scale_y_log10(limits = c(0.001, 1),
                labels = scales::comma_format(accuracy = 0.001)) +
  scale_x_log10(limits = c(0.001, 10),
                labels = scales::comma_format(accuracy = 0.001)) +
  theme_minimal(base_size = 12) +
  scale_shape_discrete("Contains\nstemmed\npoints?") +
  scale_size("Total number\nof artifacts") +
  scale_color_viridis_c(name = "Age of\nassemblage (ka)") +
  xlab("Artifact volumetric density") +
  ylab("Proportion of retouched pieces") +
  annotate("text",
           x = 0.005,
           y = 0.7,
           label = "Curated",
           size = size -2,
           colour = "grey50") +
    annotate("text",
           x = 5,
           y = 0.01,
           label = "Expedient",
           size = size -2,
           colour = "grey50") +
    annotate("text",
           x = 0.03,
           y = 0.02,
           label = glue('r = {round(r_value, 3)}\n, t({df_value}) =  {round(t_value, 3)}, p = {round(p_value, 3)}'),
           size = size - 2,
           colour = "grey50")

library(cowplot)
ggdraw(Assemblage_info_retouch_density_ages_prop_main_plot) +
  draw_plot(retouch_over_time_subplot, 
            .1, .1, 
            .35, .25) 

```



Summed probability distribution

To understand the population change during the appearance of stemmed points, we analyzed the summed probability distributions of 171 radiocarbon dates from 33 cultural layers to get a rough image of population dynamics at the sites. The result indicates that there is a higher density of radiocarbon dates from around 34 ka. We could cautiously assume that the population flux might relate to the technological innovation. 

```{r cache=TRUE}
dates_clean <- 
  dates %>% 
  mutate(age = parse_number(as.character(age)),
         error = parse_number(as.character(error))) %>% 
  filter(age < 50000, method=='AMS')

# devtools::install_github('ahb108/rcarbon')
library(rcarbon)
dates_calibrated <- 
  calibrate(x=dates_clean$age,
               errors=dates_clean$error,
               calCurves='intcal13')

dates_calibrated_spd <-  spd(dates_calibrated, timeRange = c( 45000, 1000))
plot(dates_calibrated_spd)

# Testing Observed SPDs against theoretical models
## recalibrate dates without normalisation to avoid artificial peaks
spd_dates<- calibrate(x=dates_clean$age,errors=dates_clean$error,normalised=FALSE,verbose=F) 

### this code takes long time
spd_test <- modelTest(spd_dates,errors=dates_clean$error,timeRange=c(45000,1000),model='exponential',nsim=200,ncores=3)

summary(spd_test)
plot(spd_test)

# zoom in in on the 40-30ka period GP is trying
spd_test_zoom <- modelTest(spd_dates,errors=dates_clean$error,timeRange=c(40000,30000),model='exponential',nsim=200,ncores=3)
summary(spd_test_zoom)
plot(spd_test_zoom)

# zoom in in on the 40-30ka period, testing other models
uni_test <- modelTest(spd_dates,errors=dates_clean$error,timeRange=c(40000,30000), model='uniform',nsim=200,ncores=3)
plot(uni_test)

lin_test <- modelTest(spd_dates,errors=dates_clean$error,timeRange=c(40000,30000), model='linear',nsim=200,ncores=3)
plot(lin_test)
```


Raw materials

During the transition period, the use of shale and rhyolite greatly increased. These two raw materials are suitable to make elongate blades and stemmed points. It is considered that he hunter-gatherer started to use raw materials selectively depending on the type of tool, especially the newly produced stemmed points. Raw material availability is a crucial factor in determining the trip and direction for hunter-gatherers [@davies2018modeling]. Therefore the adoption of new raw material along with the emergence of new type of tools demonstrates a significant innovation in not just technology but also cognitive system.    

```{r}
#raw material information
kasr_long1 <- 
  kasr %>% 
  gather(site, 
         count, 
         -X) %>% 
  group_by(site) %>% 
  mutate(percentage = count / sum(count, na.rm = TRUE) * 100,
         total = sum(count, na.rm = TRUE)) %>% 
  filter(!is.na(percentage)) %>% 
  # if percentage is <10%, call it 'other'
  mutate(raw_material = ifelse(percentage >= 10, as.character(X), "other")) %>% 
  mutate(raw_material = ifelse(raw_material == "etc.", "other", raw_material)) %>% 
  select(-X)


  # if percentage is <10%, call it 'other'
kasr_long2 <- 
  kasr_long1 %>% 
  group_by(site, raw_material) %>% 
  summarise(percentage = sum(percentage)) %>% 
  ungroup() %>% 
  left_join(kasr_long1 %>% 
              select(site, raw_material, total),
            by = c('site', "raw_material")) %>% 
  distinct(.keep_all = TRUE) %>% 
  # join to get ages of the sites
  left_join(mydata_ages, 
            by = c('site' = 'site_name')) %>% 
 # mutate(age_ka = jitter(age_ka),
 #        age_bin  = ntile(age_ka, 5)) %>% 
  arrange(age_ka) %>% 
  filter(!is.na(age_ka)) %>% 
    mutate(axis_label = glue('{site} ({round(age_ka,1)} ka, n = {total})')) 


ggplot(kasr_long2, 
       aes(
           reorder(axis_label, 
                   -age_ka),
           percentage,
           fill = raw_material)) +
  geom_col(position = "fill") +
  xlab("Assemblage (youngest at the top)") +
  ylab("Percentage") +
  scale_fill_viridis_d(name = "Raw material type",
                       option = "C") +
  coord_flip() +
  theme_minimal(base_size = 12) 

```
Umap


# Discussion 

1. The new technology and occupation in high elevation

The new technology appeared around 40-35ka in the Korean Peninsula includes stemmed points and following blade industry. The stemmed points brought new paradigms in stone artifact assemblages. For example, projectile points are only a part of composit artifacts and this specific characteristics could contribute to increase efficiency of maintaining the toolkit by easily replacing the damaged part [@kuhn2015artifacts; @cardillo2010some]. Combining with other materials increases utility or functionality of the tool by adding extra weight and providing a shaft, which makes it earlier to grip. Selective use of raw material might impact on hunter-gathers’ mobility and occupation pattern depending on availability of the specific raw materials such as shale and rhyolite. In addition, this research shows that carrying the points enabled hunter-gatherers to occupy higher elevation compared to the sites with no stemmed points. Therefore, we can assume that the technology would play an important role to survive in more risky environments. 

2. Population change

Interpreted in HBE, we expected there might be close connection between environmental change and the appearance of new technology based on the prediction that the new invention was the result of risk. The research suggests that the environmental pressure could be related to population change. We cannot simply predicate that the increased population around 35ka was due to dispersal of Homo Sapiens since there is no reliable human remains in South Korea. However, the migration of Homo sapiens was not impossible scenario at the same time. In fact, one model explains that the emergence of stemmed points and blade industry came from outside of the Korean peninsula and the new technology was the result of the continuous influx of modern human populations from Siberia while the earlier coarse flake trandition was come from southern China [@Bae_2010]. Since this migration model barely explains about preexisted stone artifact assemblages and people in the Korean Peninsula, it is hard to accept his argument without knowing about the native people. In short, we assume that the stemmed points appeared related to the increased population and it can be related to the modern human dispersal or indigenously increased occupants.        

3. Expedient vs curated

To monitor mobility strategies and site occupation pattern, we examined the artifact density and retouch frequency, based on the premise that highly mobile foragers would have light weighted, highly retouched, replaceable, almost completely made tools and leave small amount of artifacts when they move to the new location (curated). One the other hand, less mobile foragers who tend to stay in one place yield more debitage and debris, produce less efficient tools since they can easily get supplied (expedient) [@clark2019landscapes; @kuhn1994formal; @kuhn2014mousterian; @meignen2006middle]. Therefore, the curated technology indicates sites with special or highly mobile groups with stone artifacts that are thoroughly designed and based on a high level of investment of time and effort in artifact manufacture and maintenance. The expedient technology represents base camp or residence with artifacts that tend to be manufactured, used, and abandoned in the short period of time [@vaquero2018searching;@binford1979organization; @torrence1989time]. There appear to be more variety in the type of sites (or group) during the transition period, both expedient or curated. It became more expedient at the end of the transition, which means foragers became less mobile and tended to stay in the base camp. Combined with the result of population dynamics, we can assume that the increased population made each group bigger and let them stay in one place. 

# Conclusion 

This research aims to understand how the appearance of new technology affected hunter-gatherers in Korea and answer the three questions, how did the introduction of the new tools change the way people used the landscape, the way people used sites, and the population. To answer the question, we use HBE as a theoretical backgrounds and analyze stone artifacts from 22 sites dated before and after 40-35ka. The new technology is represented the stemmed points and other blade industry made out of new raw materials such as shale and rhyolite. We could clearly see that hunter-gatherers chose these materials particularly to make the newly added stone artifacts to the toolkit. The results also show that the new technology enables the occupation of marginal environments at higher elevations. Besides of technological change, we found that there are more varieties in the type of sites or groups during the transition period, both curated and expedient and then it becomes more expedient. In other words, the foragers became less mobile and prone to stay in one place after the transition ended. We expected to see any pattern that would explain the relationship between environmental change and the emergence of the new technology. However, there was not enough paleoenvironmental information as well as data to apply to verify the model. Therefore we focus on Radiocarbon dates as a proxy of population change based on the premise that population driven pressure could trigger people to invent a new tool. The results show that population dynamics might have had more impact on changes in stone artifact technology. 


------------NOT WORKING-------------


Get the lithic data for some sites:




```{r}

# try not to use googlesheet and make the upper chunck work

library(readxl)
path <- "analysis/data/raw_data/Overall_info.xlsx"
excel_sheets(path = path)

p_sheets <- c("general_info" ,"assemblage_info")

k_kas_sites_sheets <- map(p_sheets, ~path %>% read_excel )

#simply combine the two data sets of general info and assemblage info?
#kk_sheets <- c (mydata, kasa)


```

Compute artefact volumetric density by frequency of retouched piece (log scale), following Julien Riel-Salvatore and C. Michael Barton in  https://www.jstor.org/stable/4128419


```{r}
# put the site names on this list of data frames
site_names <-  kas_sites_sheets[[1]] %>%  
  select(-X1) %>% 
  names()

# density of arefacts at each site
artefact_density <- 
kas_sites_sheets[[1]] %>% 
  t %>% 
  as.data.frame() %>% 
 rownames_to_column() %>% 
  mutate_all(as.character) 

names(artefact_density) <- as.character(as.vector(artefact_density[1, ]))
artefact_density <- artefact_density[-1,]

artefact_density <- 
artefact_density %>% 
  mutate(density = as.numeric(total_artifacts) / as.numeric(volume)) %>% 
   mutate_at(2:ncol(.), as.numeric)  

# frequency of retouched artefacts
retouched_artefacts <- 
 kas_sites_sheets[[2]] %>% 
   filter(!X1 %in% c("debris", 
                     "unkown", 
                     "pebble",  
                     "metate", 
                     "flake",
                     "unfinished",
                     "ground",
                     "blank"
                     )) %>% 
    t %>% 
  as.data.frame() %>% 
 rownames_to_column() %>% 
  mutate_all(as.character) 

names(retouched_artefacts) <- as.character(as.vector(retouched_artefacts[1, ]))
retouched_artefacts <- retouched_artefacts[-1,]

retouched_artefacts <- 
retouched_artefacts %>% 
  mutate_at(2:ncol(.), as.numeric)  %>% 
  mutate(total_retouched = rowSums(.[,-1], na.rm = TRUE))


# join together the site age, artefact density df with the retouched artefacts df
kas_density_retouch_ages <- 
artefact_density %>% 
  left_join(retouched_artefacts) %>% 
  mutate(proportion_retouched = total_retouched / total_artifacts) %>% 
  mutate(sites = X1)

 
# compute correlation
kas_sites_retouch_density_corr <- 
cor.test(kas_density_retouch_ages$proportion_retouched,
         kas_density_retouch_ages$density)

r_value <- unname(kas_sites_retouch_density_corr$estimate)

```


```{r}
size <-  8


ggplot(kas_density_retouch_ages,
       aes(density,
           proportion_retouched
           )) +
  geom_point(aes(colour = date_age / 1000,
                 size = total_artifacts,
                 shape = is.na(stemmed_point))) +
 # geom_text_repel(aes(label = sites),
 #                 nudge_x = 0.075, 
 #                 nudge_y = -0.075,
 #                 size = 5) +
  geom_smooth(alpha = 0.2) +
  scale_y_log10(limits = c(0.001, 1),
                labels = scales::comma_format(accuracy = 0.001)) +
  scale_x_log10(limits = c(0.001, 10),
                labels = scales::comma_format(accuracy = 0.001)) +
  theme_minimal(base_size = 12) +
  scale_color_viridis_c(name = "Age of\nassemblage (ka)") +
  xlab("Artifact volumetric density") +
  ylab("Proportion of retouched pieces") +
  annotate("text",
           x = 0.005,
           y = 0.7,
           label = "Curated",
           size = size -2,
           colour = "grey50") +
    annotate("text",
           x = 5,
           y = 0.01,
           label = "Expedient",
           size = size -2,
           colour = "grey50") +
    annotate("text",
           x = 0.01,
           y = 0.01,
           label = glue('r = {round(r_value, 3)}'),
           size = size - 2,
           colour = "grey50")

```

```{r}
# I wanna make simple table for artifact density and frequency of retouched pieces again. Because the complex table above is hard to make comments..



ggplot(kas_density_retouch_ages,
       aes(density,
           proportion_retouched
           )) +
  geom_point(aes(colour = date_age / 1000,
                 size = 7)) +
 # geom_text_repel(aes(label = sites),
 #                 nudge_x = 0.075, 
 #                 nudge_y = -0.075,
 #                 size = 5) +
  geom_smooth(alpha = 0.2) +
  scale_y_log10(limits = c(0.001, 1),
                labels = scales::comma_format(accuracy = 0.001)) +
  scale_x_log10(limits = c(0.001, 10),
                labels = scales::comma_format(accuracy = 0.001)) +
  theme_minimal(base_size = 12) +
  scale_color_viridis_c(name = "Age of\nassemblage (ka)") +
  xlab("Artifact volumetric density") +
  ylab("Proportion of retouched pieces") +
  annotate("text",
           x = 0.005,
           y = 0.7,
           label = "Curated",
           size = size -2,
           colour = "grey50") +
    annotate("text",
           x = 5,
           y = 0.01,
           label = "Expedient",
           size = size -2,
           colour = "grey50") +
    annotate("text",
           x = 0.01,
           y = 0.01,
           label = glue('r = {round(r_value, 3)}'),
           size = size - 2,
           colour = "grey50")



```


Artefact volumetric density and frequency of retouched pieces can be proxies to identify the characteristics of the hunter-gatherers who carried that stone tools whether they are residentially mobile or logistically orgnized foragers based on the premise that the relationship between lithic assemblage composition and land-use strategy represent an expression of economizing behavior. 

The artefact volumetric density is defined as the total number of artefacts per cubic meter of excavated sediment, and served as a proxy for accumulation ratio of artefacts. the relative frequency of retouched pieces is the count of retouched flake tools devided by the total number of artifacts. 

The two ends of the curated-expedient show that residential to logistical mobility. Expedient assemblages can be depicted as "base camps" or "residences", while curated ones represent either residential mobility, where the central locus of group changes frequently, or certain task groups from a central residential site. 

The plot show that younger sites are likely to be used as base camp than older site, which means that people tended to stay longer at one place after around 40-35ka. 

(Riel-Salvatore and Barton 2004)


```{r}
# dating
library(rcarbon)

# I'm working through https://cran.r-project.org/web/packages/rcarbon/vignettes/rcarbon.html

kas_ages <- 
kas_density_retouch_ages %>% 
  select(sites, date_age, date_error) %>% 
  mutate(sites = str_remove_all(sites, "_"))

kas_caldates <- 
  calibrate(x = kas_ages$date_age,
            errors = kas_ages$date_error,
            calCurves='intcal13',
            ncores=3) #running calibration over 3 cores

kas_spd = spd(kas_caldates, timeRange = c(50000,25000)) 
plot(kas_spd)

binsense(x=kas_caldates,
         y=kas_ages$sites,
         h=seq(0,5000,100),
         timeRange=c(50000,25000)) 

ggplot(kas_spd$grid,
       aes(calBP,
           PrDens)) +
  geom_line() +
  scale_y_log10(name = "Summed probability")


# test how the SPD fits to an exponential growth model:
expnull <- modelTest(kas_caldates, 
                     errors=kas_ages$date_error, 
                     nsim=100, 
                     timeRange=c(50000,25000),
                     model="uniform",
                     runm=10)

plot(expnull)

```

# Acknowledgements

<!-- The following line inserts a page break when the output is MS Word. For page breaks in PDF, use \newpage on its own line.  -->
##### pagebreak

# References 
<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->
<div id="refs"></div>

##### pagebreak

### Colophon

This report was generated on `r Sys.time()` using the following computational environment and dependencies: 

```{r colophon, cache = FALSE}
# which R packages and versions?
devtools::session_info()
```

The current Git commit details are:

```{r}
# what commit is this file at? 
git2r::repository(here::here())
```
